// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// Defines the different types of point transactions
enum TransactionType {
  ADMIN_GRANT   // Points given by an admin
  PRIZE_REDEEM  // Points spent on a prize
  EVENT_TOPUP   // Points gained from an event QR code
}

// User model - still holds the current point total for quick access
model User {
  userId            String              @id @default(cuid())
  name              String?
  email             String?             @unique
  qrCodeIdentifier  String              @unique @default(cuid())
  points            Int                 @default(0)
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  deletedAt         DateTime?           // Soft delete flag
  
  // Relation to Admin who created this user
  adminId           String?
  createdBy         Admin?              @relation(fields: [adminId], references: [adminId])
  
  // A user can have many point transactions
  transactions      PointTransaction[]
  // A user can attend many events
  eventAttendances  UserEventAttendance[]
  // A user can be a facilitator (optional)
  facilitator       UserFacilitator?

  // A user can join many classes
  userClasses       UserClass[]
  // A user can have a cart
  carts             Cart[]
}

// Admin model - now with QR login capability
model Admin {
  adminId                String             @id @default(cuid())
  email                  String             @unique
  qrCodeIdentifier       String             @unique @default(cuid()) // For QR code login
  availablePointsToGrant Int                @default(100)
  createdAt              DateTime           @default(now())
  updatedAt              DateTime           @updatedAt

  // An admin can be the source of many point grants
  grantedTransactions    PointTransaction[]
  createdPrizes          Prize[]
  createdEvents          Event[]
  createdUsers           User[]             // An admin can create many users
}

// UserFacilitator model - limited admin access, linked to User
model UserFacilitator {
  facilitatorId          String   @id @default(cuid())
  userId                 String   @unique // Link to User table
  availablePointsToGrant Int      @default(100) // Points they can grant to users
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  // Relation to User
  user                   User     @relation(fields: [userId], references: [userId])

  // A facilitator can create prizes
  createdPrizes          Prize[]
  // A facilitator can grant points to users
  grantedTransactions    PointTransaction[]
}

// The new model to log every single point transaction
model PointTransaction {
  id          String          @id @default(cuid())
  amount      Int             
  type        TransactionType
  description String?         
  createdAt   DateTime        @default(now())

  // Relation to User (every transaction must belong to a user)
  userId      String
  user        User            @relation(fields: [userId], references: [userId])

  // Optional relation to Admin (for ADMIN_GRANT type transactions)
  adminId     String?
  admin       Admin?          @relation(fields: [adminId], references: [adminId])

  // Optional relation to UserFacilitator (for facilitator grants)
  facilitatorId String?
  facilitator   UserFacilitator? @relation(fields: [facilitatorId], references: [facilitatorId])

  // Note: Only one of adminId or facilitatorId should be set for grant transactions
  // We can add a relation to an Event model here in the future
  // eventId  String?
}

// Prize model - can be created by Admin or UserFacilitator
model Prize {
  prizeId     String   @id @default(cuid())
  name        String
  description String?
  imageUrl    String?  @db.VarChar(256)
  sourceUrl   String?
  pointCost   Int
  stock       Int      @default(0)
  isEnabled   Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  deletedAt   DateTime?

  // Relation to Admin: A prize can be created by an admin
  adminId          String?
  createdByAdmin   Admin?           @relation(fields: [adminId], references: [adminId])

  // Relation to UserFacilitator: A prize can be created by a facilitator
  facilitatorId         String?
  createdByFacilitator  UserFacilitator? @relation(fields: [facilitatorId], references: [facilitatorId])

  // Note: Application logic should ensure only one of adminId or facilitatorId is set
  // A prize can be in many user carts
  userCarts UserCart[]
}

// Event model - tracks events that users can attend
model Event {
  eventId     String   @id @default(cuid())
  title       String
  description String?
  eventBanner String?  // URL or path to event banner image
  pointAmount Int      // Points awarded for attending this event
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  deletedAt   DateTime? // Soft delete flag

  // Relation to Admin: An event must be created by one admin
  adminId     String
  createdBy   Admin    @relation(fields: [adminId], references: [adminId])
  
  // An event can have many attendees
  attendances UserEventAttendance[]
}

// UserEventAttendance - junction table tracking which users attended which events
model UserEventAttendance {
  id         Int      @id @default(autoincrement())
  attendedAt DateTime @default(now())
  
  // Relation to User
  userId     String
  user       User     @relation(fields: [userId], references: [userId])
  
  // Relation to Event
  eventId    String
  event      Event    @relation(fields: [eventId], references: [eventId])
  
  // Ensure a user can only attend an event once
  @@unique([userId, eventId])
}

// Class model - represents a class/course users can join
model Class {
  classId     String   @id @default(cuid())
  imageUrl    String?
  title       String
  description String?
  location    String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  deletedAt   DateTime?

  // Users enrolled in this class
  userClasses UserClass[]
}

// UserClass model - join table for users and classes
model UserClass {
  id        String   @id @default(cuid())
  userId    String
  classId   String
  joinedAt  DateTime @default(now())

  user      User     @relation(fields: [userId], references: [userId])
  class     Class    @relation(fields: [classId], references: [classId])

  @@unique([userId, classId])
}

// UserCart model - represents prizes added to a user's cart
model UserCart {
  id        Int      @id @default(autoincrement())
  cartId    Int
  prizeId   String
  quantity  Int      @default(1)
  addedAt   DateTime @default(now())

  cart      Cart     @relation(fields: [cartId], references: [id])
  prize     Prize    @relation(fields: [prizeId], references: [prizeId])

  @@unique([cartId, prizeId])
}

// Cart model - groups UserCart items for a user
model Cart {
  id        Int      @id @default(autoincrement())
  userId    String
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [userId])
  items     UserCart[]
}